{% extends "admin/base_site.html" %}

{% block content %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap-grid.min.css">

<div id="app" class="row">
  <div class="col-2">
    <table>
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Recherche globale</td>
          <td><input v-model="paramsArtwork.q"></td>
        </tr>
        <tr>
          <td>Auteur</td>
          <td><input v-model="paramsArtwork['facets[authors]']"></td>
        </tr>
        <tr>
          <td>Period</td>
          <td>
            <select v-model="paramsArtwork['facets[periods]']">
              <option v-for="p in periods" v-bind:value="p.value">{[{p.text}]}</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Type</td>
          <td>
            <select v-model="paramsArtwork['facets[collections]']">
              <option v-for="c in collections" v-bind:value="c.value">{[{c.text}]}</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Technique</td>
          <td>
            <select v-model="paramsArtwork['facets[techniques]']">
              <option v-for="t in techniques" v-bind:value="t.value">{[{t.text}]}</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Langage</td>
          <td><input v-model="paramsArtwork.lang"></td>
        </tr>
        <tr>
          <td>Nombre de resultats</td>
          <td><input v-model="paramsArtwork.per_page"></td>
        </tr>
        <tr>
          <td>Page</td>
          <td><input v-model="paramsArtwork.page"></td>
        </tr>
      </tbody>
    </table>
    <button type="button" v-on:click="searchArtwork">Search artwork</button>
    <br><br>
    <table>
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Recherche globale</td>
          <td><input v-model="paramsAuthor.q"></td>
        </tr>
      </tbody>
    </table>
    <button type="button" v-on:click="searchAuthor">Search author</button>
    <div v-for="a in authors">
      {[{ a._source.name.fr }]} - {[{ a._score }]}
    </div>
  </div>
  <div class="col-10">
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Add to db</th>
          <th>Title</th>
          <th>Author</th>
          <th>Date</th>
          <th>Image</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="a in artworks">
          <td><input type="checkbox"/></td>
          <td>{[{ getTitle(a, 'fr') }]}</td>
          <td>{[{ getName(a, 'fr') }]}</td>
          <td>{[{ getDate(a) }]}</td>
          <td style="text-align:center;">
            <img class="artwork" v-bind:src="getImage(a)" height="50"/>
          </td>
          <td>{[{ parseInt(a._score) }]}</td>
        </tr>
      </tbody>
    </table>
    <div v-show="artworks.length < 1" style="padding:15px;text-align:center;">
      No artwork found.
    </div>
  </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zeitiger/elevatezoom@2.5.4/jquery.elevatezoom.min.js"></script>
<script type="text/javascript">
  var RMNGP_API_KEY = '{{RMNGP_API_KEY}}';
</script>
<script type="text/javascript">
  function objectToHttpQuery(o){
    return Object.keys(o)
      .filter(function(k){return o[k] && o[k].toString().length > 0; })
      .map(function(k){return k + '=' + o[k] })
      .join('&').replace(' ', '%20');
  }
  var app = new Vue({
    delimiters: ['{[{', '}]}'],
    el: '#app',
    data: {
      paramsArtwork: {
        lang: 'fr',
        per_page: 15,
        page: 1,
        q: '',
        'facets[techniques]': '',
        'facets[periods]': '',
        'facets[collections]': 'Peintures',
      },
      paramsAuthor: {
        q: 'van gogh',
      },
      artworks: [],
      authors: [],
      collections: [
        {value: '', text: 'All'},
        {value: 'Dessins', text: 'Dessins (108k)'},
        {value: 'Photographies', text: 'Photographies (92k)'},
        {value: 'Estampes', text: 'Estampes (43k)'},
        {value: 'Objets d\'art', text: 'Objets d\'art (40k)'},
        {value: 'D.A.G.', text: 'D.A.G. (40k)'},
        {value: 'Peintures', text: 'Peintures (31k)'},
        {value: 'Arts de l\'Islam', text: 'Arts de l\'Islam (17k)'},
        {value: 'Arts de l\'Extrême-Orient', text: 'Arts de l\'Extrême-Orient (16k)'},
        {value: 'collection Rothschild', text: 'collection Rothschild (14k)'},
        {value: 'Sculptures', text: 'Sculptures (13k)'},
      ],
      techniques: [
        {value:'', text:'All'},
        {value:'dessin à la plume', text:'dessin à la plume (24k)'},
        {value:'mine de plomb', text:'mine de plomb (23k)'},
        {value:'huile sur toile', text:'huile sur toile (23k)'},
        {value:'dessin au crayon', text:'dessin au crayon (18k)'},
        {value:'aquarelle', text:'aquarelle (17k)'},
      ],
      periods: [
        {value:'', text:'All'},
        {value:'Europe (période) - période moderne', text:'Europe moderne 1492-1789 (60k)'},
        {value:'Europe (période) - période contemporaine 1789-1914', text:'Europe contemporaine 1789-1914 (159k)'},
        {value:'17e siècle', text:'17e (35k)'},
        {value:'18e siècle', text:'18e (45k)'},
        {value:'19e siècle', text:'19e (175k)'},
        {value:'20e siècle', text:'20e (125k)'},
      ],
    },
    methods:{
      searchArtwork: function(){
        var query = objectToHttpQuery(app.paramsArtwork);
        var url =
        $.ajax({
          url: 'https://api.art.rmngp.fr/v1/works?'+query,
          type: "GET",
          beforeSend: function(xhr){xhr.setRequestHeader('ApiKey', RMNGP_API_KEY);},
          success: function(data) {
            console.log(data);
            app.artworks = data['hits']['hits'];
            setTimeout(function(){
              $('.artwork').elevateZoom({
                zoomWindowPosition: 10,
                zoomWindowWidth: 900, //400
                zoomWindowHeight: 600, // 400
              });
              console.log('elevateZoom OK');
            }, 3000);
          }
        });
      },
      searchAuthor: function(){
        var query = objectToHttpQuery(app.paramsAuthor);
        var url =
        $.ajax({
          url: 'https://api.art.rmngp.fr/v1/authors?'+query,
          type: "GET",
          beforeSend: function(xhr){xhr.setRequestHeader('ApiKey', RMNGP_API_KEY);},
          success: function(data) {
            console.log(data);
            app.authors = data['hits']['hits'];
          }
        });
      },
      getTitle: function(artwork, lang){
        if(artwork._source && artwork._source.title && artwork._source.title[lang]){
          return artwork._source.title[lang];
        }
        return '';
      },
      getName: function(artwork, lang){
        if(artwork._source && artwork._source.authors.length > 0 && artwork._source.authors[0].name){
          return artwork._source.authors[0].name[lang];
        }
        return '';
      },
      getImage: function(artwork){
        if(artwork._source && artwork._source.images.length > 0){
          return artwork._source.images[0].urls.original;
        }
        return '';
      },
      getDate: function(artwork){
        if(artwork._source && artwork._source.date && artwork._source.date.display){
          return artwork._source.date.display;
        }
        return '';
      }
    }
  })
</script>
{% endblock %}
